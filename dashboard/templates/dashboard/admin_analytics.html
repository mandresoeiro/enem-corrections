{% extends "dashboard/base.html" %}
{% block title %}Analytics — ENEM Corrections{% endblock %}
{% block header %}Analytics do Sistema{% endblock %}

{% block content %}

<!-- CARDS DE RESUMO -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">

  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow border border-gray-200 dark:border-gray-700">
    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Redações no último mês</h3>
    <p class="text-3xl font-bold text-emerald-600 dark:text-emerald-400 mt-2">
      {{ essays_last_month|default:128 }}
    </p>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Envios recentes</p>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow border border-gray-200 dark:border-gray-700">
    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Taxa de Correção</h3>
    <p class="text-3xl font-bold text-emerald-600 dark:text-emerald-400 mt-2">
      {{ correction_rate|default:"92%" }}
    </p>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Redações corrigidas / enviadas</p>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow border border-gray-200 dark:border-gray-700">
    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Professores Ativos</h3>
    <p class="text-3xl font-bold text-emerald-600 dark:text-emerald-400 mt-2">
      {{ active_teachers|default:6 }}
    </p>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Corrigindo atualmente</p>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow border border-gray-200 dark:border-gray-700">
    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300">Tempo Médio de Correção</h3>
    <p class="text-3xl font-bold text-emerald-600 dark:text-emerald-400 mt-2">
      {{ avg_correction_time|default:18 }} min
    </p>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Por redação</p>
  </div>

</div>

<!-- GRID DOS GRÁFICOS -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

  <!-- Gráfico 1: Redações por mês -->
  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow border border-gray-200 dark:border-gray-700">
    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">
      Redações enviadas por mês
    </h2>
    <canvas id="essaysPerMonthChart" class="w-full h-64"></canvas>
  </div>

  <!-- Gráfico 2: Pendências por professor -->
  <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow border border-gray-200 dark:border-gray-700">
    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">
      Pendências por professor
    </h2>
    <canvas id="pendingPerTeacherChart" class="w-full h-64"></canvas>
  </div>

</div>

<!-- Gráfico 3: Distribuição de usuários -->
<div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow border border-gray-200 dark:border-gray-700 mb-4">
  <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">
    Distribuição de usuários por papel
  </h2>
  <div class="flex flex-col md:flex-row items-center gap-6">
    <div class="w-full md:w-1/2">
      <canvas id="usersByRoleChart" class="w-full h-64"></canvas>
    </div>
    <div class="w-full md:w-1/2 space-y-2 text-sm text-gray-600 dark:text-gray-300">
      <p><span class="font-semibold">Alunos:</span> {{ users_students|default:320 }}</p>
      <p><span class="font-semibold">Professores:</span> {{ users_teachers|default:12 }}</p>
      <p><span class="font-semibold">Admins:</span> {{ users_admins|default:3 }}</p>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
        Esses dados podem ser alimentados diretamente da API (Django + DRF) para refletir o ambiente real.
      </p>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Você pode substituir esses dados por valores vindos do backend via contexto,
  // ou via endpoint JSON com fetch().
  const essaysPerMonthData = {
    labels: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
    datasets: [{
      label: "Redações enviadas",
      data: [35, 48, 60, 52, 80, 95, 110, 90, 76, 88, 120, 140],
      tension: 0.3,
      fill: true
    }]
  };

  const pendingPerTeacherData = {
    labels: ["Prof. Ana", "Prof. Bruno", "Prof. Carla", "Prof. Diego", "Prof. Elisa"],
    datasets: [{
      label: "Pendências",
      data: [4, 7, 2, 9, 3]
    }]
  };

  const usersByRoleData = {
    labels: ["Alunos", "Professores", "Admins"],
    datasets: [{
      data: [320, 12, 3]
    }]
  };

  // Configuração de tema básico (usa cores padrão do Chart.js,
  // mas o background do card já segue o dark mode via Tailwind).
  const ctx1 = document.getElementById("essaysPerMonthChart").getContext("2d");
  new Chart(ctx1, {
    type: "line",
    data: essaysPerMonthData,
    options: {
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true }
      }
    }
  });

  const ctx2 = document.getElementById("pendingPerTeacherChart").getContext("2d");
  new Chart(ctx2, {
    type: "bar",
    data: pendingPerTeacherData,
    options: {
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true }
      }
    }
  });

  const ctx3 = document.getElementById("usersByRoleChart").getContext("2d");
  new Chart(ctx3, {
    type: "doughnut",
    data: usersByRoleData,
    options: {
      plugins: {
        legend: {
          position: "bottom"
        }
      }
    }
  });
</script>

{% endblock %}